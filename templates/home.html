<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KVITKOVA POVNYA</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        body { background: #181818; color: #f8fafc; }
        .insta-logo {
            width: 96px; height: 96px; object-fit: cover; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 2px solid #fff; background: #fff;
        }
        .main-card { background: #232323; border-radius: 1.5rem; box-shadow: 0 2px 16px rgba(0,0,0,0.12); }
        .btn-main { background: #c19a6b; color: #fff; font-weight: 600; border: none; }
        .btn-main:hover { background: #a67c52; }
        .btn-outline-light { color: #fff; border-color: #fff; }
        .btn-outline-light:hover { background: #fff; color: #232323; }
    </style>
</head>
<body>
<div class="container py-5">
    <div class="text-center mb-4">
        <img src="/static/logoKvitkova.jpg" alt="Kvitkova Povnya Logo" class="insta-logo mb-2">
        <h1 class="fw-bold">KVITKOVA POVNYA</h1>
        <div class="mb-2">Квіти Київ | підписка на квіти</div>
        <div class="mb-3" style="color:#c19a6b;">Квіти не тільки на свята</div>
        <div class="mb-4">
            <span class="me-3">Щотижнева/щомісячна підписка</span>
            <span class="me-3">Безкоштовна доставка</span>
            <span>Подарунки (ваза, ножиці)</span>
        </div>
    </div>
    <div class="row justify-content-center mb-5">
        <div class="col-md-8">
            <div class="main-card p-5 text-center">
                <div class="d-flex flex-column gap-4">
                    <button class="btn btn-main btn-lg w-100" data-bs-toggle="modal" data-bs-target="#addOrderModal">Додати замовлення</button>
                    <a href="/generator" class="btn btn-main btn-lg w-100">Розрахувати оптимальний маршрут</a>
                    <button class="btn btn-outline-light btn-lg w-100" data-bs-toggle="modal" data-bs-target="#ordersModal">Переглянути замовлення</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="addOrderModal" tabindex="-1" aria-labelledby="addOrderModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title" id="addOrderModalLabel">Додати замовлення</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="addOrderForm" autocomplete="off">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Instagram</label>
            <input type="text" class="form-control" name="instagram" id="instagramInput" placeholder="@vladbilobrov" lang="en">
          </div>
          <div class="mb-3">
            <label class="form-label">Місто</label>
            <input type="text" class="form-control" name="city" id="cityField" placeholder="Місто" required lang="uk">
          </div>
          <div class="mb-3">
            <label class="form-label">Вулиця</label>
            <input type="text" class="form-control" name="street" id="streetField" placeholder="Почніть вводити назву вулиці..." required autocomplete="off" lang="uk">
          </div>
          <div class="mb-3">
            <div class="row g-2 align-items-end">
              <div class="col-md-4">
                <label class="form-label">Номер будинку</label>
                <input type="text" class="form-control" name="building" id="buildingField" placeholder="231" required lang="uk">
              </div>
              <div class="col-md-4">
                <label class="form-label">КВ/поверх</label>
                <input type="text" class="form-control" name="apartment" id="apartmentField" placeholder="Квартира або поверх">
              </div>
              <div class="col-md-4">
                <label class="form-label">Під'їзд</label>
                <input type="text" class="form-control" name="entrance" id="entranceField" placeholder="Під'їзд">
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Номер телефону</label>
            <input type="tel" class="form-control" name="phone" placeholder="+380" id="phoneInput" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Тип замовлення</label>
            <select class="form-select" name="order_type">
              <option value="Разова">Разова</option>
              <option value="Підписка">Підписка</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Розмір</label>
            <select class="form-select" name="size">
              <option value="M">M</option>
              <option value="L">L</option>
              <option value="XL">XL</option>
              <option value="XXL">XXL</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Коментар</label>
            <input type="text" class="form-control" name="comment" placeholder="Деталі, побажання...">
          </div>
          <div class="mb-3">
            <label class="form-label">Часове вікно доставки</label>
            <div class="row">
              <div class="col">
                <input type="time" class="form-control" name="time_window_start" placeholder="з">
              </div>
              <div class="col">
                <input type="time" class="form-control" name="time_window_end" placeholder="до">
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Скасувати</button>
          <button type="submit" class="btn btn-main">Додати</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Orders Modal -->
<div class="modal fade" id="ordersModal" tabindex="-1" aria-labelledby="ordersModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title" id="ordersModalLabel">Список замовлень</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="ordersList"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрити</button>
        <button type="button" class="btn btn-main" id="downloadCsvBtn">Вивантажити адреси</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/imask"></script>
<script>
// Маска для телефону
IMask(document.getElementById('phoneInput'), { mask: '+{380} 00 000 00 00' });

document.getElementById('addOrderForm').onsubmit = function(e) {
  e.preventDefault();
  const form = e.target;
  // Перевірка обов'язкових полів
  if (!form.city.value.trim() || !form.street.value.trim() || !form.building.value.trim() || !form.phone.value.trim()) {
    alert('Будь ласка, заповніть місто, вулицю, номер будинку та номер телефону!');
    return;
  }
  const data = {
    instagram: form.instagram.value,
    city: form.city.value,
    street: form.street.value,
    building: form.building.value,
    phone: form.phone.value,
    order_type: form.order_type.value,
    size: form.size.value,
    comment: form.comment.value,
    time_window_start: form.time_window_start.value,
    time_window_end: form.time_window_end.value
  };
  // Додаємо у mockOrders
  mockOrders.push(data);
  // Якщо модалка замовлень відкрита — оновлюємо список
  const ordersModal = document.getElementById('ordersModal');
  if (ordersModal.classList.contains('show')) {
    updateOrdersList();
  }
  const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('addOrderModal'));
  modal.hide();
  form.reset();
};

// Винести оновлення списку замовлень у функцію
function updateOrdersList() {
  const list = document.getElementById('ordersList');
  if (!mockOrders.length) {
    list.innerHTML = '<div class="text-muted">Замовлень поки немає.</div>';
    return;
  }
  let html = '<table class="table table-dark table-striped table-hover align-middle"><thead><tr>' +
    '<th>Instagram</th><th>Адреса</th><th>Телефон</th><th>Тип</th><th>Розмір</th><th>Коментар</th><th>Часове вікно</th></tr></thead><tbody>';
  for (const o of mockOrders) {
    html += `<tr><td>${o.instagram}</td><td>${o.city}, ${o.street}, ${o.building}</td><td>${o.phone}</td><td>${o.order_type}</td><td>${o.size}</td><td>${o.comment}</td><td>${(o.time_window_start||'') + (o.time_window_end ? ' - ' + o.time_window_end : '')}</td></tr>`;
  }
  html += '</tbody></table>';
  list.innerHTML = html;
}

document.getElementById('ordersModal').addEventListener('show.bs.modal', updateOrdersList);

// Мокані замовлення
const mockOrders = [
  {
    instagram: '@vladbilobrov',
    city: 'Київ',
    street: 'Нагірна',
    building: '18/16',
    phone: '+380 67 123 45 67',
    order_type: 'Підписка',
    size: 'L',
    comment: 'Доставити до 10:00'
  },
  {
    instagram: '@testuser',
    city: 'Київ',
    street: 'Хрещатик',
    building: '1',
    phone: '+380 50 987 65 43',
    order_type: 'Разова',
    size: 'XL',
    comment: 'Зателефонувати перед доставкою'
  },
  {
    instagram: '@flowers',
    city: 'Київ',
    street: 'Саксаганського',
    building: '20',
    phone: '+380 93 555 44 33',
    order_type: 'Підписка',
    size: 'M',
    comment: ''
  }
];

document.getElementById('downloadCsvBtn').onclick = function() {
  if (!mockOrders.length) return;
  // Формуємо CSV-рядки
  let csv = 'address,time_window_start,time_window_end\n';
  for (const o of mockOrders) {
    // Якщо немає time_window_start/end — залишаємо порожнім
    const addr = (o.city + ', ' + o.street + ', ' + o.building || '').replace(/"/g, '""');
    const start = o.time_window_start || '';
    const end = o.time_window_end || '';
    csv += `"${addr}",${start},${end}\n`;
  }
  // Створюємо Blob і посилання для завантаження
  const blob = new Blob([csv], {type: 'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'orders.csv';
  document.body.appendChild(a);
  a.click();
  setTimeout(() => {
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }, 100);
};

function initSearchDropdowns() {
  try {
    const streetField = document.getElementById('streetField');
    const cityField = document.getElementById('cityField');
    const buildingField = document.getElementById('buildingField');
    
    if (!streetField || !cityField || !buildingField) {
      console.error('Не знайдено необхідні поля форми');
      return;
    }
    
    // Перевіряємо чи доступний Google Maps API
    if (!window.google || !window.google.maps || !window.google.maps.places) {
      console.error('Google Maps API недоступний');
      createSearchDropdown(streetField, 'streets');
      createSearchDropdown(cityField, 'cities');
      return;
    }
    
    // Створюємо пошук з Google Places API
    createGoogleSearchDropdown(streetField, 'streets');
    createGoogleSearchDropdown(cityField, 'cities');
    
  } catch (error) {
    console.error('Помилка ініціалізації пошуку:', error);
  }
}

// Функція для створення пошуку з Google Places API
function createGoogleSearchDropdown(field, type) {
  let dropdown = null;

  field.addEventListener('input', function() {
    const query = this.value;
    if (query.length < 2) {
      hideDropdown();
      return;
    }

    hideDropdown();

    dropdown = document.createElement('div');
    dropdown.className = 'search-dropdown';
    dropdown.style.cssText = `
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      color: #111;
      border: 1px solid #ddd;
      border-top: none;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1001;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    `;
    
    // Додаємо індикатор завантаження
    const loadingItem = document.createElement('div');
    loadingItem.textContent = 'Пошук...';
    loadingItem.style.cssText = `
      padding: 10px;
      color: #666;
      font-style: italic;
    `;
    dropdown.appendChild(loadingItem);
    
    field.parentNode.style.position = 'relative';
    field.parentNode.appendChild(dropdown);
    
    // Google Places API
    const service = new google.maps.places.AutocompleteService();
    const request = {
      input: query,
      componentRestrictions: { country: 'ua' },
      types: type === 'cities' ? ['(cities)'] : ['route']
    };

    service.getPlacePredictions(request, (predictions, status) => {
      dropdown.innerHTML = '';
      if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
        predictions.forEach(prediction => {
          let displayText = prediction.description;
          if (type === 'cities' || type === 'streets') {
            displayText = prediction.structured_formatting.main_text;
            if (!/[а-яіїєґА-ЯІЇЄҐ]/.test(displayText)) return;
          }
          const item = document.createElement('div');
          item.className = 'search-item';
          item.textContent = displayText;
          item.style.cssText = `
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s, color 0.2s;
            background: #fff;
            color: #111;
          `;
          item.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f0f0f0';
            this.style.color = '#111';
          });
          item.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '#fff';
            this.style.color = '#111';
          });
          item.addEventListener('click', function() {
            field.value = displayText;
            hideDropdown();
          });
          dropdown.appendChild(item);
        });
      } else {
        const noResults = document.createElement('div');
        noResults.textContent = 'Нічого не знайдено';
        noResults.style.cssText = `
          padding: 10px;
          color: #666;
          font-style: italic;
        `;
        dropdown.appendChild(noResults);
      }
    });
  });
  
  field.addEventListener('blur', function() {
    setTimeout(hideDropdown, 200);
  });
  
  function hideDropdown() {
    if (dropdown) {
      dropdown.remove();
      dropdown = null;
    }
  }
}

// Простий пошук без Google API
function createSearchDropdown(field, type = 'streets') {
  const commonStreets = [
    'Хрещатик',
    'Велика Васильківська',
    'Саксаганського',
    'Нагірна',
    'Берестейська',
    'Січових Стрільців',
    'Володимирська',
    'Тарасівська',
    'Пушкінська',
    'Львівська',
    'Золотоворітська',
    'Ярославів Вал',
    'Печерська',
    'Кловський узвіз',
    'Інститутська',
    'Шовковична',
    'Мазепи',
    'Січових Стрільців',
    'Бульвар Лесі Українки',
    'Маршала Тимошенка'
  ];
  
  const commonCities = [
    'Київ',
    'Львів',
    'Харків',
    'Одеса',
    'Дніпро',
    'Запоріжжя',
    'Вінниця',
    'Полтава',
    'Черкаси',
    'Суми',
    'Хмельницький',
    'Тернопіль',
    'Рівне',
    'Житомир',
    'Чернігів',
    'Чернівці',
    'Івано-Франківськ',
    'Луцьк',
    'Ужгород',
    'Кропивницький'
  ];
  
  const data = type === 'cities' ? commonCities : commonStreets;
  
  field.addEventListener('input', function() {
    const value = this.value.toLowerCase();
    if (value.length < 2) {
      // Приховуємо список якщо текст занадто короткий
      const existingList = document.getElementById('street-suggestions');
      if (existingList) existingList.remove();
      return;
    }
    
    const matches = data.filter(item => 
      item.toLowerCase().includes(value)
    );
    
    // Видаляємо попередній список
    const existingList = document.getElementById('street-suggestions');
    if (existingList) existingList.remove();
    
    if (matches.length > 0) {
      const list = document.createElement('ul');
      list.id = 'street-suggestions';
      list.style.cssText = `
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        border-top: none;
        max-height: 150px;
        overflow-y: auto;
        width: 100%;
        z-index: 1000;
        list-style: none;
        margin: 0;
        padding: 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      `;
      
      matches.forEach(street => {
        const item = document.createElement('li');
        item.textContent = street;
        item.style.cssText = `
          padding: 10px;
          cursor: pointer;
          border-bottom: 1px solid #eee;
          transition: background-color 0.2s;
        `;
        item.addEventListener('click', function() {
          field.value = item.textContent;
          list.remove();
        });
        item.addEventListener('mouseenter', function() {
          this.style.backgroundColor = '#f0f0f0';
        });
        item.addEventListener('mouseleave', function() {
          this.style.backgroundColor = 'white';
        });
        list.appendChild(item);
      });
      
      field.parentNode.style.position = 'relative';
      field.parentNode.appendChild(list);
    }
  });
  
  // Приховуємо список при кліку поза ним
  document.addEventListener('click', function(e) {
    if (!field.contains(e.target)) {
      const list = document.getElementById('street-suggestions');
      if (list) list.remove();
    }
  });
  
  // Обробка клавіш для fallback автокомпліту
  field.addEventListener('keydown', function(e) {
    const list = document.getElementById('street-suggestions');
    if (!list) return;
    
    const items = list.querySelectorAll('li');
    const currentIndex = Array.from(items).findIndex(item => 
      item.style.backgroundColor === 'rgb(240, 240, 240)'
    );
    
    switch(e.key) {
      case 'ArrowDown':
        e.preventDefault();
        const nextIndex = currentIndex < items.length - 1 ? currentIndex + 1 : 0;
        items.forEach(item => item.style.backgroundColor = 'white');
        items[nextIndex].style.backgroundColor = '#f0f0f0';
        break;
      case 'ArrowUp':
        e.preventDefault();
        const prevIndex = currentIndex > 0 ? currentIndex - 1 : items.length - 1;
        items.forEach(item => item.style.backgroundColor = 'white');
        items[prevIndex].style.backgroundColor = '#f0f0f0';
        break;
      case 'Enter':
        e.preventDefault();
        const selectedItem = list.querySelector('li[style*="background-color: rgb(240, 240, 240)"]');
        if (selectedItem) {
          field.value = selectedItem.textContent;
          list.remove();
        }
        break;
      case 'Escape':
        list.remove();
        break;
    }
  });
}
window.initAutocomplete = initSearchDropdowns;

// Перевіряємо чи Google Maps API завантажився
window.addEventListener('DOMContentLoaded', function() {
  console.log('DOM завантажений, перевіряємо Google Maps API...');
  if (window.google && window.google.maps && window.google.maps.places) {
    console.log('Google Maps API доступний, ініціалізуємо автокомпліт...');
    initAutocomplete();
  } else {
    console.error('Google Maps API не завантажився або недоступний');
    console.log('window.google:', window.google);
    console.log('window.google.maps:', window.google?.maps);
    console.log('window.google.maps.places:', window.google?.maps?.places);
  }
});

// Додаткова перевірка на випадок, якщо API завантажиться пізніше
window.addEventListener('load', function() {
  if (window.google && window.google.maps && window.google.maps.places) {
    if (!window.autocompleteInitialized) {
      initAutocomplete();
      window.autocompleteInitialized = true;
    }
  }
});

// document.getElementById('instagramInput').addEventListener('focus', function() {
//   this.setAttribute('lang', 'en');
//   this.setAttribute('placeholder', 'Instagram (ENG layout)');
// });

['cityField', 'streetField', 'buildingField'].forEach(id => {
  const el = document.getElementById(id);
  if (el) {
    el.addEventListener('focus', function() {
      this.setAttribute('lang', 'uk');
      if (id === 'cityField') this.setAttribute('placeholder', 'Місто');
      if (id === 'streetField') this.setAttribute('placeholder', 'Почніть вводити назву вулиці...');
      if (id === 'buildingField') this.setAttribute('placeholder', 'Номер будинку');
    });
  }
});
</script>
<script
  src="https://maps.googleapis.com/maps/api/js?key={{ API_KEY or 'AIzaSyBbmw6d_MV5OUwsqFM_EIiQ31ZiYU0so8Y' }}&callback=initAutocomplete&libraries=places&v=weekly&language=uk"
  defer
></script>
</body>
</html> 